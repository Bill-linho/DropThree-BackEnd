CREATE TABLE USUARIO (
ID_USUARIO SERIAL PRIMARY KEY,
NOME VARCHAR(100) NOT NULL,
EMAIL VARCHAR(150) NOT NULL UNIQUE,
TELEFONE VARCHAR(20),
SENHA_HASH VARCHAR(80) NOT NULL,
DATA_ATIVACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE PRODUTO (
    ID_PRODUTO SERIAL PRIMARY KEY,
    NOME_PRODUTO VARCHAR(180) NOT NULL,
    URL VARCHAR(250) NOT NULL,
    DESCRICAO TEXT NOT NULL,
    DIRECIONAMENTO VARCHAR(2100) NOT NULL
);

CREATE OR REPLACE FUNCTION CONTROLE_DE_ESTOQUE()
RETURNS TRIGGER AS $$
BEGIN
    IF (SELECT estoque FROM produto WHERE id_produto = NEW.id_produto) < NEW.quantidade THEN
        RAISE EXCEPTION 'Estoque insuficiente';
    END IF;

    UPDATE produto
    SET estoque = estoque - NEW.quantidade
    WHERE id_produto = NEW.id_produto;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tg_baixa_estoque
BEFORE INSERT ON pedido_item
FOR EACH ROW
EXECUTE FUNCTION baixa_estoque();